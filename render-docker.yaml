# ============================================================================
# Render Configuration - DOCKER DEPLOYMENT (OPTIMIZED)
# ============================================================================
# This configuration uses Docker for much faster builds (3-5 mins vs 30+ mins)
#
# Prerequisites:
#   1. Build and push base image (see Dockerfile.base)
#   2. Update Dockerfile with your base image name
#   3. Rename this file to render.yaml
#
# Migration from Python to Docker:
#   1. Back up current render.yaml
#   2. Replace with this file
#   3. Push to trigger deployment
# ============================================================================

services:
  - type: web
    name: DokGuru-voice-api
    # ========================================================================
    # DOCKER CONFIGURATION (Builds from base image with app code)
    # ========================================================================
    env: docker
    region: oregon
    plan: free
    branch: main

    # ========================================================================
    # DOCKER BUILD SETTINGS (Uses pre-built base image from Docker Hub)
    # ========================================================================
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend

    # ========================================================================
    # BUILD OPTIMIZATION
    # ========================================================================
    # Only rebuild when backend files change
    autoDeploy: false  # Manual deploys only to save build minutes
    buildFilter:
      paths:
        - backend/**
      ignoredPaths:
        - backend/**/*.md
        - backend/tests/**
        - frontend/**
        - "*.md"
        - docs/**
        - img/**

    # ========================================================================
    # ENVIRONMENT VARIABLES
    # ========================================================================
    envVars:
      # Flask Configuration
      - key: FLASK_ENV
        value: production

      # Python Version (for metadata)
      - key: PYTHON_VERSION
        value: 3.11.0

      # API Keys (set these in Render dashboard)
      - key: GROQ_API_KEY
        sync: false
      - key: SAMBANOVA_API_KEY
        sync: false
      - key: OPENROUTER_API_KEY
        sync: false
      - key: HUGGINGFACE_API_TOKEN
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: GEMINI_API_KEY
        sync: false
      - key: GEMINI_VISION_MODEL
        value: gemini-1.5-flash

      # Azure TTS (Optional - for premium voice quality)
      - key: AZURE_SPEECH_KEY
        sync: false
      - key: AZURE_SPEECH_REGION
        value: centralindia

      # Redis Cache
      - key: UPSTASH_REDIS_REST_URL
        sync: false
      - key: UPSTASH_REDIS_REST_TOKEN
        sync: false

      # Database
      - key: SUPABASE_URL
        sync: false
      - key: SUPABASE_KEY
        sync: false
      - key: SUPABASE_JWT_SECRET
        sync: false

      # Security
      - key: SECRET_KEY
        generateValue: true

      # CORS Origins
      - key: CORS_ORIGINS
        value: http://localhost:5173,http://localhost:3000,https://dokguru.vercel.app

      # Gunicorn Configuration (for performance tuning)
      - key: GUNICORN_WORKERS
        value: 1
      - key: GUNICORN_THREADS
        value: 8

      # Application Settings
      - key: MAX_CONTENT_LENGTH
        value: 52428800  # 50MB
      - key: CHUNK_SIZE
        value: 1000
      - key: CHUNK_OVERLAP
        value: 200
      - key: TOP_K_RESULTS
        value: 5
      - key: QUERY_CACHE_TTL
        value: 3600

    # ========================================================================
    # PERSISTENT DISK
    # ========================================================================
    disk:
      name: data
      mountPath: /opt/render/project/src/data
      sizeGB: 1

    # ========================================================================
    # HEALTH CHECK
    # ========================================================================
    healthCheckPath: /

# ============================================================================
# NOTES
# ============================================================================
#
# Build Time Comparison:
#   - Before (Python): 30+ minutes
#   - After (Docker):  3-5 minutes
#   - Savings:         85%+ reduction
#
# Build Minutes Usage (500 mins/month free tier):
#   - Before: ~17 builds/month max
#   - After:  ~100 builds/month max
#
# Base Image Maintenance:
#   - Rebuild base image when adding new ML dependencies
#   - Base image builds don't count against Render build minutes (build locally)
#   - App image builds are very fast (only lightweight dependencies)
#
# Troubleshooting:
#   1. If build fails, check Docker Hub image is accessible
#   2. Verify Dockerfile FROM line matches your pushed base image
#   3. Check Render logs for specific errors
#
# Performance Tips:
#   - Increase GUNICORN_WORKERS if you upgrade from free tier
#   - Monitor memory usage in Render dashboard
#   - Use QUERY_CACHE_TTL to balance freshness vs performance
#
# ============================================================================
