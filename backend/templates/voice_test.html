<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocuMind Voice - Test Interface</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }

        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .test-section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button.recording {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.05);
            }
        }

        input[type="text"],
        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            margin: 10px 0;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result strong {
            color: #667eea;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        .status {
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .mic-icon {
            font-size: 24px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé§ DocuMind Voice</h1>
        <p class="subtitle">Test Voice Features</p>

        <!-- Test 1: Speech to Text -->
        <div class="test-section">
            <h2>1Ô∏è‚É£ Speech to Text (STT)</h2>
            <button id="recordBtn" onclick="toggleRecording()">
                <span class="mic-icon">üé§</span> Start Recording
            </button>
            <div id="sttStatus"></div>
            <div id="sttResult"></div>
        </div>

        <!-- Test 2: Text to Speech -->
        <div class="test-section">
            <h2>2Ô∏è‚É£ Text to Speech (TTS)</h2>
            <textarea id="ttsInput"
                placeholder="Enter text to convert to speech...">Hello! This is DocuMind Voice, your AI-powered document assistant.</textarea>
            <button onclick="testTTS()">üîä Generate Speech</button>
            <div id="ttsStatus"></div>
            <div id="ttsResult"></div>
        </div>

        <!-- Test 3: Voice Query (Full Pipeline) -->
        <div class="test-section">
            <h2>3Ô∏è‚É£ Voice Query (Complete Pipeline)</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                Upload a PDF first, then ask questions using your voice!
            </p>
            <button id="voiceQueryBtn" onclick="toggleVoiceQuery()">
                <span class="mic-icon">üé§</span> Ask Question (Voice)
            </button>
            <div id="voiceQueryStatus"></div>
            <div id="voiceQueryResult"></div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        // Check browser support
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Your browser does not support audio recording. Please use Chrome, Firefox, or Edge.');
        }

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording('stt');
            } else {
                stopRecording('stt');
            }
        }

        async function toggleVoiceQuery() {
            if (!isRecording) {
                await startRecording('voice-query');
            } else {
                stopRecording('voice-query');
            }
        }

        async function startRecording(mode) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    if (mode === 'stt') {
                        await transcribeAudio(audioBlob);
                    } else if (mode === 'voice-query') {
                        await voiceQuery(audioBlob);
                    }
                    stream.getTracks().forEach(track => track.stop());
                };

                mediaRecorder.start();
                isRecording = true;

                const btn = mode === 'stt' ? document.getElementById('recordBtn') : document.getElementById('voiceQueryBtn');
                btn.classList.add('recording');
                btn.innerHTML = '<span class="mic-icon">‚èπÔ∏è</span> Stop Recording';

                const statusDiv = mode === 'stt' ? 'sttStatus' : 'voiceQueryStatus';
                document.getElementById(statusDiv).innerHTML = '<div class="status info">üéôÔ∏è Recording... Speak now!</div>';

            } catch (error) {
                alert('Error accessing microphone: ' + error.message);
            }
        }

        function stopRecording(mode) {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;

                const btn = mode === 'stt' ? document.getElementById('recordBtn') : document.getElementById('voiceQueryBtn');
                btn.classList.remove('recording');
                btn.innerHTML = '<span class="mic-icon">üé§</span> ' + (mode === 'stt' ? 'Start Recording' : 'Ask Question (Voice)');

                const statusDiv = mode === 'stt' ? 'sttStatus' : 'voiceQueryStatus';
                document.getElementById(statusDiv).innerHTML = '<div class="status info">‚è≥ Processing audio...</div>';
            }
        }

        async function transcribeAudio(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'recording.wav');

            try {
                const response = await fetch('/transcribe', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('sttStatus').innerHTML = '<div class="status success">‚úÖ Transcription complete!</div>';
                    document.getElementById('sttResult').innerHTML = `
                        <div class="result">
                            <strong>Transcribed Text:</strong><br>
                            ${data.text}<br><br>
                            <small>Language: ${data.language} | Duration: ${data.duration.toFixed(2)}s</small>
                        </div>
                    `;
                } else {
                    document.getElementById('sttStatus').innerHTML = `<div class="status error">‚ùå Error: ${data.message}</div>`;
                }
            } catch (error) {
                document.getElementById('sttStatus').innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testTTS() {
            const text = document.getElementById('ttsInput').value;
            if (!text.trim()) {
                alert('Please enter some text');
                return;
            }

            document.getElementById('ttsStatus').innerHTML = '<div class="status info">‚è≥ Generating speech...</div>';

            try {
                const response = await fetch('/speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('ttsStatus').innerHTML = '<div class="status success">‚úÖ Speech generated!</div>';
                    document.getElementById('ttsResult').innerHTML = `
                        <div class="result">
                            <strong>Generated Audio:</strong><br>
                            <audio controls src="${data.audio_url}"></audio><br>
                            <small>Duration: ${data.duration.toFixed(2)}s</small>
                        </div>
                    `;
                } else {
                    document.getElementById('ttsStatus').innerHTML = `<div class="status error">‚ùå Error: ${data.message}</div>`;
                }
            } catch (error) {
                document.getElementById('ttsStatus').innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function voiceQuery(audioBlob) {
            const formData = new FormData();
            formData.append('audio', audioBlob, 'query.wav');

            try {
                const response = await fetch('/voice-query', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('voiceQueryStatus').innerHTML = '<div class="status success">‚úÖ Query complete!</div>';
                    document.getElementById('voiceQueryResult').innerHTML = `
                        <div class="result">
                            <strong>Your Question:</strong><br>
                            ${data.question}<br><br>
                            <strong>Answer:</strong><br>
                            ${data.answer}<br><br>
                            <strong>Audio Response:</strong><br>
                            <audio controls src="${data.audio_url}"></audio><br><br>
                            <small>
                                Language: ${data.transcription_language} | 
                                Sources: ${data.metadata.sources_used} | 
                                Confidence: ${(data.metadata.confidence * 100).toFixed(0)}%
                            </small>
                        </div>
                    `;
                } else {
                    document.getElementById('voiceQueryStatus').innerHTML = `<div class="status error">‚ùå Error: ${data.message}</div>`;
                }
            } catch (error) {
                document.getElementById('voiceQueryStatus').innerHTML = `<div class="status error">‚ùå Error: ${error.message}</div>`;
            }
        }
    </script>
</body>

</html>