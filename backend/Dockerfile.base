# ============================================================================
# DokGuru Voice - Optimized Base Image (NO PyTorch, NO Coqui, NO OpenCV-DEV)
# Supports:
# - OCR (eng, hin, kan)
# - PDF extraction (pdfplumber, PyMuPDF)
# - Tabula (Java for table extraction)
# - TTS (gTTS + Azure)
# - SpeechRecognition
# - sentence-transformers (CPU only)
# Estimated size: ~1.5â€“1.8 GB
# ============================================================================

FROM python:3.11-slim

LABEL maintainer="DokGuru Team"
LABEL description="Optimized base image for DokGuru Voice"
LABEL version="1.2-clean"

# ============================================================================
# SYSTEM DEPENDENCIES
# ============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    g++ \
    git \
    wget \
    curl \
    ffmpeg \
    libsndfile1 \
    tesseract-ocr \
    tesseract-ocr-eng \
    tesseract-ocr-hin \
    tesseract-ocr-kan \
    default-jre \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# Python package upgrades
# ============================================================================
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# ============================================================================
# ML / AI (CPU-only PyTorch)
# ============================================================================
# Install PyTorch CPU-only FIRST to avoid CUDA dependencies (~2GB saved)
RUN pip install --no-cache-dir \
    torch==2.5.1 \
    --index-url https://download.pytorch.org/whl/cpu

# Then install sentence-transformers (will use CPU PyTorch)
RUN pip install --no-cache-dir \
    sentence-transformers==2.7.0 \
    transformers==4.57.1 \
    huggingface-hub==0.36.0 \
    tokenizers==0.22.1 \
    chromadb==1.0.20 \
    numpy==1.26.4 \
    pandas==2.3.3 \
    scikit-learn==1.7.2 \
    scipy==1.16.3

# ============================================================================
# TTS (gTTS + Azure only)
# ============================================================================
RUN pip install --no-cache-dir \
    gTTS==2.5.4 \
    azure-cognitiveservices-speech==1.47.0 \
    pydub==0.25.1 \
    soundfile==0.13.1

# ============================================================================
# PDF + OCR processing
# ============================================================================
RUN pip install --no-cache-dir \
    pdfplumber==0.10.3 \
    pypdf==3.17.4 \
    PyMuPDF==1.23.8 \
    tabula-py==2.10.0 \
    pytesseract==0.3.10 \
    Pillow==10.4.0

# ============================================================================
# LLM Clients
# ============================================================================
RUN pip install --no-cache-dir \
    groq==0.4.1 \
    openai==1.108.1 \
    google-generativeai==0.8.5 \
    anthropic==0.72.0

# ============================================================================
# Speech-to-text
# ============================================================================
RUN pip install --no-cache-dir \
    SpeechRecognition==3.14.3

# ============================================================================
# TTS ENGINES (Optimized for Performance)
# ============================================================================
# Install Piper TTS (Fast, Offline English TTS - 0.3s synthesis time)
RUN wget -O /tmp/piper.tar.gz https://github.com/rhasspy/piper/releases/download/v1.2.0/piper_amd64.tar.gz && \
    tar -xzf /tmp/piper.tar.gz -C /usr/local/bin && \
    chmod +x /usr/local/bin/piper && \
    rm /tmp/piper.tar.gz

# Download Piper voice model (English - en_US-lessac-medium, high quality, fast)
RUN mkdir -p /app/tts_models && \
    wget -O /app/tts_models/en_US-lessac-medium.onnx https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_US/lessac/medium/en_US-lessac-medium.onnx && \
    wget -O /app/tts_models/en_US-lessac-medium.onnx.json https://huggingface.co/rhasspy/piper-voices/resolve/v1.0.0/en/en_US/lessac/medium/en_US-lessac-medium.onnx.json

# Install edge-tts (Microsoft Edge TTS - Excellent quality for Indian languages)
# Supports: Hindi, Kannada, Tamil, Telugu, Malayalam, Bengali, Gujarati, Marathi, etc.
RUN pip install --no-cache-dir edge-tts==6.1.9

# ============================================================================
# Pre-download MiniLM model
# ============================================================================
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"

# ============================================================================
# CLEANUP
# ============================================================================
RUN pip cache purge && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

WORKDIR /app

CMD ["python", "--version"]
