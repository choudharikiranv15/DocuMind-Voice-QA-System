# ============================================================================
# DokGuru Voice - LIGHTWEIGHT BASE IMAGE (Without Coqui TTS)
# ============================================================================
# This version excludes Coqui TTS to save ~500MB and reduce build time
# Use this if you only need gTTS and Azure TTS
#
# Build time: ~15-20 minutes (faster than full version)
# Image size: ~3.5GB (vs 4.5GB with Coqui)
# ============================================================================

FROM python:3.11-slim

LABEL maintainer="DokGuru Team"
LABEL description="Lightweight base image for DokGuru Voice (no Coqui TTS)"
LABEL version="1.0-light"

# ============================================================================
# SYSTEM DEPENDENCIES
# ============================================================================
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    gcc \
    g++ \
    git \
    tesseract-ocr \
    tesseract-ocr-eng \
    tesseract-ocr-hin \
    tesseract-ocr-kan \
    libopencv-dev \
    libsndfile1 \
    ffmpeg \
    default-jre \
    wget \
    curl \
    && rm -rf /var/lib/apt/lists/*

# ============================================================================
# PYTHON PACKAGES
# ============================================================================
# Upgrade pip first to latest version
RUN pip install --no-cache-dir --upgrade pip setuptools wheel

# ============================================================================
# CORE ML/AI (PyTorch - CPU only)
# ============================================================================
RUN pip install --no-cache-dir \
    torch==2.5.1 \
    torchvision==0.20.1 \
    torchaudio==2.5.1 \
    --index-url https://download.pytorch.org/whl/cpu

RUN pip install --no-cache-dir \
    sentence-transformers==2.7.0 \
    transformers==4.57.1 \
    huggingface-hub==0.36.0 \
    tokenizers==0.22.1 \
    chromadb==1.0.20 \
    numpy==1.26.4 \
    pandas==2.3.3 \
    scikit-learn==1.7.2 \
    scipy==1.16.3

# ============================================================================
# TTS ENGINES (gTTS + Azure only, NO Coqui)
# ============================================================================
RUN pip install --no-cache-dir \
    gTTS==2.5.4 \
    azure-cognitiveservices-speech==1.47.0 \
    pydub==0.25.1 \
    soundfile==0.13.1

# ============================================================================
# PDF PROCESSING
# ============================================================================
# Install pdfplumber first (it will install compatible pdfminer.six version)
RUN pip install --no-cache-dir \
    pdfplumber==0.10.3

# Then install other PDF libraries
RUN pip install --no-cache-dir \
    pypdf==3.17.4 \
    PyMuPDF==1.23.8 \
    tabula-py==2.10.0 \
    pytesseract==0.3.10 \
    Pillow==10.4.0 \
    opencv-python-headless==4.11.0.86

# ============================================================================
# LLM CLIENTS
# ============================================================================
RUN pip install --no-cache-dir \
    groq==0.4.1 \
    openai==1.108.1 \
    google-generativeai==0.8.5 \
    anthropic==0.72.0

# ============================================================================
# SPEECH-TO-TEXT
# ============================================================================
RUN pip install --no-cache-dir \
    SpeechRecognition==3.14.3

# ============================================================================
# PRE-DOWNLOAD MODELS
# ============================================================================
RUN python -c "from sentence_transformers import SentenceTransformer; SentenceTransformer('sentence-transformers/all-MiniLM-L6-v2')"

# ============================================================================
# CLEANUP
# ============================================================================
RUN pip cache purge && \
    apt-get autoremove -y && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/* /root/.cache

ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
WORKDIR /app

CMD ["python", "--version"]
